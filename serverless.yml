# serverless.yml

service: aqts-capture-raw-load

provider:
  name: aws
  region: ${opt:region, 'us-west-2'}
  stage: ${opt:stage, 'TEST'}
  runtime: python3.8
  timeout: 70
  logRetentionInDays: 90
  role: arn:aws:iam::#{AWS::AccountId}:role/csr-Lambda-Role
  vpc: ${self:custom.vpc}
  environment:
    DB_HOST: ${self:custom.db.connectInfo.DATABASE_ADDRESS}
    DB_USER: ${self:custom.db.connectInfo.SCHEMA_OWNER_USERNAME}
    DB_NAME: ${self:custom.db.connectInfo.DATABASE_NAME}
    DB_PASSWORD: ${self:custom.db.connectInfo.SCHEMA_OWNER_PASSWORD}
    AWS_DEPLOYMENT_REGION: ${self:provider.region}
  deploymentBucket:
    name: ${opt:bucket, iow-cloud-applications}
  stackTags:
    "wma:applicationId": "Aquarius TS Retriever Capture Raw Loader"
    "wma:contact": "Jim Kreft jkreft@usgs.gov"
    "wma:environment": ${self:provider.stage}
    "wma:taggingVersion": "0.0.1"
    "wma:organization": IOW
    "displayName": "Raw Load"
    commitIdentifier: ${git:sha1}

custom:
  exportGitVariables: false
  environments:
    TEST: test
    QA: qa
    PROD-EXTERNAL: prod-external
  vpc:
    securityGroupIds: ${ssm:/iow/retriever-capture/${self:provider.stage}/securityGroupIds~split}
    subnetIds: ${ssm:/iow/aws/vpc/${self:provider.stage}/subnetIds~split}
  db:
    connectInfo: ${ssm:/aws/reference/secretsmanager/NWCAPTURE-DB-${self:provider.stage}~true}

functions:

  iowCaptureExtraSmall:
    handler: src.load.lambda_handler
    memorySize: 128
    reservedConcurrency: 20
    environment:
      S3_OBJECT_SIZE_LIMIT: 12800000

  iowCaptureSmall:
    handler: src.load.lambda_handler
    memorySize: 256
    reservedConcurrency: 20
    environment:
      S3_OBJECT_SIZE_LIMIT: 25600000

  iowCapture:
    handler: src.load.lambda_handler
    memorySize: 512
    reservedConcurrency: 10
    environment:
      S3_OBJECT_SIZE_LIMIT: 51200000

  iowCaptureMedium:
    handler: src.load.lambda_handler
    memorySize: 1536
    reservedConcurrency: 5
    environment:
      S3_OBJECT_SIZE_LIMIT: 150000000

resources:
  Resources:
    snsTopic:
      Type: AWS::SNS::Topic
      Properties:
        DisplayName: ${self:service}-${self:provider.stage}-topic
        TopicName: ${self:service}-${self:provider.stage}-topic
    concurrencyAlarm:
      Type: AWS::CloudWatch::Alarm
      Properties:
        AlarmName: ${self:service}-${self:provider.stage}-concurrency-alarm
        AlarmDescription: Notify when concurrency exceeds the specified threshold
        Namespace: 'AWS/Lambda'
        Dimensions:
          - Name: FunctionName
            Value:
              Ref: IowCaptureLambdaFunction
        MetricName: ConcurrentExecutions
        Statistic: Maximum
        ComparisonOperator: GreaterThanOrEqualToThreshold
        Threshold: 10
        Period: 60
        EvaluationPeriods: 1
        AlarmActions:
          - Ref: snsTopic
    errorAlarm:
      Type: AWS::CloudWatch::Alarm
      Properties:
        AlarmName: ${self:service}-${self:provider.stage}-error-alarm
        AlarmDescription: Notify when number of errors exceeds the specified threshold
        Namespace: 'AWS/Lambda'
        Dimensions:
          - Name: FunctionName
            Value:
              Ref: IowCaptureLambdaFunction
        MetricName: Errors
        Statistic: Sum
        ComparisonOperator: GreaterThanOrEqualToThreshold
        Threshold: 10
        Period: 60
        EvaluationPeriods: 1
        AlarmActions:
          - Ref: snsTopic
    snsTopicMedium:
      Type: AWS::SNS::Topic
      Properties:
        DisplayName: ${self:service}-medium-${self:provider.stage}-topic
        TopicName: ${self:service}-medium-${self:provider.stage}-topic
    concurrencyAlarmMedium:
      Type: AWS::CloudWatch::Alarm
      Properties:
        AlarmName: ${self:service}-medium-${self:provider.stage}-concurrency-alarm
        AlarmDescription: Notify when concurrency exceeds the specified threshold
        Namespace: 'AWS/Lambda'
        Dimensions:
          - Name: FunctionName
            Value:
              Ref: IowCaptureMediumLambdaFunction
        MetricName: ConcurrentExecutions
        Statistic: Maximum
        ComparisonOperator: GreaterThanOrEqualToThreshold
        Threshold: 5
        Period: 60
        EvaluationPeriods: 1
        AlarmActions:
          - Ref: snsTopicMedium
    errorAlarmMedium:
      Type: AWS::CloudWatch::Alarm
      Properties:
        AlarmName: ${self:service}-medium-${self:provider.stage}-error-alarm
        AlarmDescription: Notify when number of errors exceeds the specified threshold
        Namespace: 'AWS/Lambda'
        Dimensions:
          - Name: FunctionName
            Value:
              Ref: IowCaptureMediumLambdaFunction
        MetricName: Errors
        Statistic: Sum
        ComparisonOperator: GreaterThanOrEqualToThreshold
        Threshold: 10
        Period: 60
        EvaluationPeriods: 1
        AlarmActions:
          - Ref: snsTopicMedium

    snsTopicSmall:
      Type: AWS::SNS::Topic
      Properties:
        DisplayName: ${self:service}-small-${self:provider.stage}-topic
        TopicName: ${self:service}-small-${self:provider.stage}-topic
    concurrencyAlarmSmall:
      Type: AWS::CloudWatch::Alarm
      Properties:
        AlarmName: ${self:service}-small-${self:provider.stage}-concurrency-alarm
        AlarmDescription: Notify when concurrency exceeds the specified threshold
        Namespace: 'AWS/Lambda'
        Dimensions:
          - Name: FunctionName
            Value:
              Ref: IowCaptureSmallLambdaFunction
        MetricName: ConcurrentExecutions
        Statistic: Maximum
        ComparisonOperator: GreaterThanOrEqualToThreshold
        Threshold: 20
        Period: 60
        EvaluationPeriods: 1
        AlarmActions:
          - Ref: snsTopicSmall
    errorAlarmSmall:
      Type: AWS::CloudWatch::Alarm
      Properties:
        AlarmName: ${self:service}-small-${self:provider.stage}-error-alarm
        AlarmDescription: Notify when number of errors exceeds the specified threshold
        Namespace: 'AWS/Lambda'
        Dimensions:
          - Name: FunctionName
            Value:
              Ref: IowCaptureSmallLambdaFunction
        MetricName: Errors
        Statistic: Sum
        ComparisonOperator: GreaterThanOrEqualToThreshold
        Threshold: 10
        Period: 60
        EvaluationPeriods: 1
        AlarmActions:
          - Ref: snsTopicSmall

    snsTopicExtraSmall:
      Type: AWS::SNS::Topic
      Properties:
        DisplayName: ${self:service}-extra-small-${self:provider.stage}-topic
        TopicName: ${self:service}-extra-small-${self:provider.stage}-topic
    concurrencyAlarmExtraSmall:
      Type: AWS::CloudWatch::Alarm
      Properties:
        AlarmName: ${self:service}-extra-small-${self:provider.stage}-concurrency-alarm
        AlarmDescription: Notify when concurrency exceeds the specified threshold
        Namespace: 'AWS/Lambda'
        Dimensions:
          - Name: FunctionName
            Value:
              Ref: IowCaptureExtraSmallLambdaFunction
        MetricName: ConcurrentExecutions
        Statistic: Maximum
        ComparisonOperator: GreaterThanOrEqualToThreshold
        Threshold: 20
        Period: 60
        EvaluationPeriods: 1
        AlarmActions:
          - Ref: snsTopicSmall
    errorAlarmExtraSmall:
      Type: AWS::CloudWatch::Alarm
      Properties:
        AlarmName: ${self:service}-extra-small-${self:provider.stage}-error-alarm
        AlarmDescription: Notify when number of errors exceeds the specified threshold
        Namespace: 'AWS/Lambda'
        Dimensions:
          - Name: FunctionName
            Value:
              Ref: IowCaptureSmallLambdaFunction
        MetricName: Errors
        Statistic: Sum
        ComparisonOperator: GreaterThanOrEqualToThreshold
        Threshold: 10
        Period: 60
        EvaluationPeriods: 1
        AlarmActions:
          - Ref: snsTopicSmall

plugins:
  - serverless-plugin-git-variables
  - serverless-pseudo-parameters
  - serverless-python-requirements

package:
  exclude:
    - node_modules/**
    - Dockerfile
    - .dockerignore
    - Jenkinsfile
    - package.json
    - package-lock.json
